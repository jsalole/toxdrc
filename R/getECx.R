#' Get ECx estimates from model
#'
#' @param dataset A dataframe.
#' @param model A drm model, generated by `modelcomp()` or `drm()`.
#' @param EDx The effect measure of interest (i.e. 0.5 for EC50)
#' @param metadata Optional. Generated by getmetadata.
#' @param list_obj Optional. Used for integration with `runtoxdrc`.
#' @param EDargs Additional arguments passed to `ED()` (e.g., type, interval, level, lower, upper, lref, uref). Should be presented in a list format. See ?ED for more info on arguments.
#'
#' @returns If list_obj is not provided, returns estimate. If list object is provided, list_obj$results stores a dataframe with the ECx estimates.
#' @importFrom drc ED
#' @export

getECx <- function(
  dataset,
  model,
  EDx = 0.5,
  metadata = NULL,
  list_obj = NULL,
  EDargs = NULL
) {
  if (is.null(EDargs)) {
    EDargs <- c(list(model, c(EDx)), EDargs)
  }

  EDvals <- tryCatch(
    as.vector(do.call(ED, EDargs)),
    error = function(e) {
      warning("ECx estimation failed in model_estimates: ", e$message)
      return(rep(NA, 4))
    }
  )

  estimate_names <- c(
    paste0("EC", EDx * 100),
    "Std. Error",
    "Lower95",
    "Upper95"
  )

  names(EDvals) <- estimate_names
  EDvals <- as.data.frame(t(EDvals))
  print(EDvals)

  if (is.null(list_obj)) {
    return(EDvals)
  }

  if (!is.null(list_obj)) {
    if (!is.list(list_obj)) {
      stop("Provided list_obj must be a list.")
    }
    results <- cbind(metadata, EDvals)
    list_obj$results <- results
    return(list_obj)
  }
}
